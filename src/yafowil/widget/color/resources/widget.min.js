var yafowil_color=function(e,t){"use strict";class s{constructor(e,s,i=!1){this.widget=e,this.color=s,this.locked=i,this.elem=t("<div />").addClass("color-swatch layer-transparent"),this.color_layer=t("<div />").addClass("layer-color").css("background-color",this.color.rgbaString).appendTo(this.elem),this.locked?this.elem.addClass("locked").appendTo(this.widget.locked_swatches_container):this.elem.appendTo(this.widget.user_swatches_container),this.destroy=this.destroy.bind(this),this.select=this.select.bind(this),this.elem.on("click",this.select)}destroy(){this.elem.off("click",this.select),this.elem.remove()}select(e){t("div.color-swatch").removeClass("selected"),this.elem.addClass("selected"),this.widget.active_swatch=this,this.widget.picker.color.set(this.color)}}class i{constructor(e,t,s,i,o={min:1e3,max:4e4}){this.widget=e,this.elem=t,this.format=i||"hexString","hexString"===this.format&&this.elem.attr("maxlength",7),this.temperature=o,this.color=s,this.update_color(s),this.on_input=this.on_input.bind(this),this.elem.on("input",this.on_input),this.update_color=this.update_color.bind(this)}on_input(e){let t=this.elem.val();if("kelvin"===this.format){if(t.toString().length<4)return;t<this.temperature.min?t=this.temperature.min:t>this.temperature.max&&(t=this.temperature.max),this.widget.picker.color.kelvin=t}else this.widget.picker.color.set(t);this.elem.val(t)}update_color(e){"kelvin"===this.format?this.elem.val(e.kelvin):this.elem.val(e[this.format])}}class o{constructor(e,s,i){this.widget=e,this.layer=t("<div />").addClass("layer-color"),this.elem=s.addClass("layer-transparent").append(this.layer).insertAfter(this.widget.elem),this.color=i.rgbaString,this.on_click=this.on_click.bind(this),this.elem.on("click",this.on_click)}get color(){return this._color}set color(e){this.layer.css("background-color",e),this._color=e}on_click(){this.widget.open()}}const h={box:"box",wheel:"wheel",r:"red",g:"green",b:"blue",a:"alpha",h:"hue",s:"saturation",v:"value",k:"kelvin"};class r{static initialize(e){t("input.color-picker",e).each((function(){let e=t(this),s={format:e.data("format"),preview_elem:e.data("preview_elem"),sliders:e.data("sliders"),box_width:e.data("box_width"),box_height:e.data("box_height"),slider_size:e.data("slider_size"),color:e.data("color"),locked_swatches:e.data("swatches"),user_swatches:e.data("user_swatches"),temperature:e.data("temperature"),disabled:e.data("disabled"),show_inputs:e.data("show_inputs"),show_labels:e.data("show_labels"),slider_length:e.data("slider_length"),layout_direction:e.data("layout_direction")};new r(e,s)}))}constructor(e,s){e.data("yafowil-color",this),this.elem=e,this.elem.attr("spellcheck","false"),this.dropdown_elem=t("<div />").addClass("color-picker-wrapper").css("top",this.elem.outerHeight()).insertAfter(this.elem),this.picker_container=t("<div />").addClass("color-picker-container").appendTo(this.dropdown_elem),this.close_btn=t("<button />").addClass("close-button").text("âœ•").appendTo(this.dropdown_elem),s.locked_swatches&&(this.locked_swatches_container=t("<div />").addClass("color-picker-recent").appendTo(this.dropdown_elem)),s.user_swatches&&(this.user_swatches_container=t("<div />").addClass("color-picker-recent").appendTo(this.dropdown_elem),this.add_color_btn=t("<button />").addClass("add_color").text("+ Add"),this.remove_color_btn=t("<button />").addClass("remove_color").text("- Remove").hide(),this.buttons=t("<div />").addClass("buttons").append(this.add_color_btn).append(this.remove_color_btn).appendTo(this.dropdown_elem)),this.slider_size=s.slider_size;let h=this.init_opts(s);this.picker=new iro.ColorPicker(this.picker_container.get(0),h);let r=s.sliders;r&&r.includes("box")&&r.includes("wheel")&&(r.indexOf("box")<r.indexOf("wheel")?t("div.IroWheel",this.picker_container).hide():t("div.IroBox",this.picker_container).hide(),this.switch_btn=t("<div />").addClass("iro-switch-toggle").append(t('<i class="glyphicon glyphicon-retweet" />')).appendTo(this.dropdown_elem),this.switch_btn.on("click",(()=>{t("div.IroWheel",this.picker_container).toggle(),t("div.IroBox",this.picker_container).toggle()}))),s.user_swatches&&(this.user_swatches=[],this.init_user_swatches()),s.locked_swatches&&(this.locked_swatches=[],this.init_locked_swatches(s.locked_swatches)),this.color=this.picker.color.clone();let l=s.temperature||{min:2e3,max:11e3};this.input_elem=new i(this,this.elem,this.color,s.format,l);let c=s.preview_elem?t(s.preview_elem).addClass("yafowil-color-picker-preview"):t("<span />").addClass("yafowil-color-picker-color layer-transparent");this.preview=new o(this,c,this.color),s.user_swatches&&(this.create_swatch=this.create_swatch.bind(this),this.add_color_btn.on("click",this.create_swatch),this.remove_swatch=this.remove_swatch.bind(this),this.remove_color_btn.on("click",this.remove_swatch),this.init_user_swatches=this.init_user_swatches.bind(this),this.elem.on("yafowil-colors:changed",this.init_user_swatches)),this.open=this.open.bind(this),this.elem.on("focus",this.open),this.update_color=this.update_color.bind(this),this.picker.on("color:change",this.update_color),this.close=this.close.bind(this),this.close_btn.on("click",this.close),this.on_keydown=this.on_keydown.bind(this),this.on_click=this.on_click.bind(this)}init_user_swatches(e){let t=localStorage.getItem("color-swatches");if(t){for(let e of this.user_swatches)e.destroy();this.user_swatches=[],this.remove_color_btn.show();let i=JSON.parse(t);this.remove_color_btn&&this.remove_color_btn.show(),this.user_swatches_container.show();for(let e of i)this.user_swatches.push(new s(this,new iro.Color(e)));if(this.user_swatches.length>10?(this.user_swatches[0].destroy(),this.user_swatches.shift()):this.user_swatches.length?this.remove_color_btn.show():this.remove_color_btn.hide(),this.user_swatches.length&&e&&e.origin===this){this.user_swatches[this.user_swatches.length-1].select()}}}init_opts(e){let t={color:e.color,width:e.box_width,boxHeight:e.box_height||e.box_width,layoutDirection:e.layout_direction||"vertical",layout:[]};return(e.sliders||[]).forEach((s=>{let i=h[s];"box"===i?t.layout.push({component:iro.ui.Box,options:{}}):"wheel"===i?t.layout.push({component:iro.ui.Wheel,options:{}}):t.layout.push({component:iro.ui.Slider,options:{sliderType:i,sliderSize:e.slider_size,sliderLength:e.slider_length,minTemperature:e.temperature?e.temperature.min:void 0,maxTemperature:e.temperature?e.temperature.max:void 0,disabled:e.disabled,showInput:e.show_inputs,showLabel:e.show_labels}})})),t}update_color(){this.color=this.picker.color.clone(),this.preview.color=this.color.rgbaString,this.input_elem.update_color(this.color)}open(e){"none"===this.dropdown_elem.css("display")?(this.dropdown_elem.show(),t(window).on("keydown",this.on_keydown),t(window).on("mousedown",this.on_click)):this.close()}on_keydown(e){"Enter"===e.key||"Escape"===e.key?(e.preventDefault(),this.close()):"Delete"===e.key&&(e.preventDefault(),this.remove_swatch())}on_click(e){let t=this.dropdown_elem;t.is(e.target)||0!==t.has(e.target).length||this.preview.elem.is(e.target)||"block"!==t.css("display")||this.close()}close(e){e&&e.preventDefault(),this.dropdown_elem.hide(),this.elem.blur(),t(window).off("keydown",this.on_keydown),t(window).off("mousedown",this.on_click)}color_equals(e){if(e instanceof iro.Color&&e.hsva.h===this.color.hsva.h&&e.hsva.s===this.color.hsva.s&&e.hsva.v===this.color.hsva.v&&e.hsva.a===this.color.hsva.a)return!0}init_locked_swatches(e){if(e&&e.length){for(let t of e){let e;if(t instanceof Array)e={r:t[0],g:t[1],b:t[2],a:t[3]||1};else{if("string"!=typeof t&&"object"!=typeof t)return void console.log(`ERROR: not supported color format at ${t}`);e=t}this.locked_swatches.push(new s(this,new iro.Color(e),!0))}this.active_swatch=this.locked_swatches[0],this.active_swatch.select(),this.locked_swatches_container.show()}}create_swatch(e){if(e&&"click"===e.type&&e.preventDefault(),this.locked_swatches)for(let e of this.locked_swatches)if(this.color_equals(e.color))return;for(let e of this.user_swatches)if(this.color_equals(e.color))return;let t=new s(this,this.picker.color.clone());this.user_swatches.push(t),this.set_swatches()}remove_swatch(e){if(e&&"click"===e.type&&e.preventDefault(),this.active_swatch.locked)return;this.active_swatch.destroy();let t=this.user_swatches.indexOf(this.active_swatch);this.user_swatches.splice(t,1),this.user_swatches.length?(this.active_swatch=this.user_swatches[this.user_swatches.length-1],this.active_swatch.select(),this.picker.color.set(this.active_swatch.color)):this.locked_swatches.length?(this.active_swatch=this.locked_swatches[this.locked_swatches.length-1],this.active_swatch.select(),this.picker.color.set(this.active_swatch.color)):(this.user_swatches_container.hide(),this.remove_color_btn.hide(),this.picker.color.reset()),this.set_swatches()}set_swatches(){let e=[];for(let t of this.user_swatches)e.push(t.color.hsva);console.log(e),localStorage.setItem("color-swatches",JSON.stringify(e));let s=new t.Event("yafowil-colors:changed",{origin:this});t("input.color-picker").trigger(s)}}return t((function(){void 0!==window.ts?ts.ajax.register(r.initialize,!0):void 0!==window.bdajax?bdajax.register(r.initialize,!0):r.initialize()})),e.ColorWidget=r,Object.defineProperty(e,"__esModule",{value:!0}),window.yafowil=window.yafowil||{},window.yafowil.color=e,e}({},jQuery);
