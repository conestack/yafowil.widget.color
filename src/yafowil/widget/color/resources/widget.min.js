var yafowil_color=function(t,e){"use strict";class s{constructor(t,s,i=!1){this.widget=t,this.color=s,this.fixed=i,this.elem=e("<div />").addClass("color-swatch layer-transparent").appendTo(this.widget.swatches_container),this.color_layer=e("<div />").addClass("layer-color").css("background-color",this.color.rgbaString).appendTo(this.elem),this.destroy=this.destroy.bind(this),this.select=this.select.bind(this),this.elem.on("click",this.select)}destroy(){this.elem.off("click",this.select),this.elem.remove()}select(t){e("div.color-swatch").removeClass("selected"),this.elem.addClass("selected"),this.widget.active_swatch=this,this.widget.picker.color.set(this.color)}}class i{constructor(t,e,s,i,o={min:1e3,max:4e4}){this.widget=t,this.elem=e,this.format=i||"hexString","hexString"===this.format&&this.elem.attr("maxlength",7),this.temperature=o,this.color=s,this.update_color(s),this.on_input=this.on_input.bind(this),this.elem.on("input",this.on_input),this.update_color=this.update_color.bind(this)}on_input(t){let e=this.elem.val();if("kelvin"===this.format){if(e.toString().length<4)return;e<this.temperature.min?e=this.temperature.min:e>this.temperature.max&&(e=this.temperature.max),this.widget.picker.color.kelvin=e}else this.widget.picker.color.set(e);this.elem.val(e)}update_color(t){"kelvin"===this.format?this.elem.val(t.kelvin):this.elem.val(t[this.format])}}class o{constructor(t,s,i){this.widget=t,this.layer=e("<div />").addClass("layer-color"),this.elem=s.addClass("layer-transparent").append(this.layer).insertAfter(this.widget.elem),this.color=i.rgbaString,this.on_click=this.on_click.bind(this),this.elem.on("click",this.on_click)}get color(){return this._color}set color(t){this.layer.css("background-color",t),this._color=t}on_click(){this.widget.open()}}const h={box:"box",wheel:"wheel",r:"red",g:"green",b:"blue",a:"alpha",h:"hue",s:"saturation",v:"value",k:"kelvin"};class r{static initialize(t){e("input.color-picker",t).each((function(t){let s=e(this),i={format:s.data("format"),preview_elem:s.data("preview_elem"),sliders:s.data("sliders"),box_width:s.data("box_width"),box_height:s.data("box_height"),slider_size:s.data("slider_size"),color:s.data("color"),swatches:s.data("swatches"),temperature:s.data("temperature"),disabled:s.data("disabled"),show_inputs:s.data("show_inputs"),show_labels:s.data("show_labels"),slider_length:s.data("slider_length"),layout_direction:s.data("layout_direction")};new r(s,i,t)}))}constructor(t,s,h){t.data("yafowil-color",this),this.elem=t,this.elem.attr("spellcheck","false"),this.dropdown_elem=e("<div />").addClass("color-picker-wrapper").css("top",this.elem.outerHeight()).insertAfter(this.elem),this.picker_container=e("<div />").addClass("color-picker-container").appendTo(this.dropdown_elem),this.close_btn=e("<button />").addClass("close-button").text("âœ•").appendTo(this.dropdown_elem),s.swatches&&(this.add_color_btn=e("<button />").addClass("add_color").text("+ Add"),this.remove_color_btn=e("<button />").addClass("remove_color").text("- Remove"),this.buttons=e("<div />").addClass("buttons").append(this.add_color_btn).append(this.remove_color_btn).appendTo(this.dropdown_elem)),this.swatches_container=e("<div />").addClass("color-picker-recent").appendTo(this.dropdown_elem),this.index=h,this.slider_size=s.slider_size;let r=this.init_opts(s);this.picker=new iro.ColorPicker(this.picker_container.get(0),r),this.swatches=[],s.swatches&&(this.fixed_swatches=[],this.fix_swatches(s.swatches)),this.parse_json(),this.color=this.picker.color.clone();let a=s.temperature||{min:2e3,max:11e3};this.input_elem=new i(this,this.elem,this.color,s.format,a);let l=s.preview_elem?e(s.preview_elem).addClass("yafowil-color-picker-preview"):e("<span />").addClass("yafowil-color-picker-color layer-transparent");this.preview=new o(this,l,this.color),s.swatches&&(this.create_swatch=this.create_swatch.bind(this),this.add_color_btn.on("click",this.create_swatch),this.remove_swatch=this.remove_swatch.bind(this),this.remove_color_btn.on("click",this.remove_swatch)),this.open=this.open.bind(this),this.elem.on("focus",this.open),this.update_color=this.update_color.bind(this),this.picker.on("color:change",this.update_color),this.close=this.close.bind(this),this.close_btn.on("click",this.close),this.on_keydown=this.on_keydown.bind(this),this.on_click=this.on_click.bind(this)}parse_json(){let t=localStorage.getItem(`color-swatches-${this.index}`);if(t){let e=JSON.parse(t);this.swatches_container.show();for(let t of e)this.swatches.push(new s(this,new iro.Color(t)));this.swatches[this.swatches.length-1].select()}}init_opts(t){let e={color:t.color,width:t.box_width,boxHeight:t.box_height||t.box_width,layoutDirection:t.layout_direction||"vertical",layout:[]};return(t.sliders||[]).forEach((s=>{let i=h[s];"box"===i?e.layout.push({component:iro.ui.Box,options:{}}):"wheel"===i?e.layout.push({component:iro.ui.Wheel,options:{}}):e.layout.push({component:iro.ui.Slider,options:{sliderType:i,sliderSize:t.slider_size,sliderLength:t.slider_length,minTemperature:t.temperature?t.temperature.min:void 0,maxTemperature:t.temperature?t.temperature.max:void 0,disabled:t.disabled,showInput:t.show_inputs,showLabel:t.show_labels}})})),e}update_color(){this.color=this.picker.color.clone(),this.preview.color=this.color.rgbaString,this.input_elem.update_color(this.color)}open(t){"none"===this.dropdown_elem.css("display")?(this.dropdown_elem.show(),e(window).on("keydown",this.on_keydown),e(window).on("mousedown",this.on_click)):this.close()}on_keydown(t){"Enter"===t.key||"Escape"===t.key?(t.preventDefault(),this.close()):"Delete"===t.key&&(t.preventDefault(),this.remove_swatch())}on_click(t){let e=this.dropdown_elem;e.is(t.target)||0!==e.has(t.target).length||this.preview.elem.is(t.target)||"block"!==e.css("display")||this.close()}close(t){t&&t.preventDefault(),this.dropdown_elem.hide(),this.elem.blur(),e(window).off("keydown",this.on_keydown),e(window).off("mousedown",this.on_click)}color_equals(t){if(t instanceof iro.Color&&t.hsva.h===this.color.hsva.h&&t.hsva.s===this.color.hsva.s&&t.hsva.v===this.color.hsva.v&&t.hsva.a===this.color.hsva.a)return!0}fix_swatches(t){if(t&&t.length){for(let e of t){let t;if(e instanceof Array)t={r:e[0],g:e[1],b:e[2],a:e[3]||1};else{if("string"!=typeof e&&"object"!=typeof e)return void console.log(`ERROR: not supported color format at ${e}`);t=e}this.fixed_swatches.push(new s(this,new iro.Color(t),!0))}this.swatches_container.show()}}create_swatch(t){t&&(t.preventDefault(),this.swatches_container.show());for(let t of this.fixed_swatches)if(this.color_equals(t.color))return;for(let t of this.swatches)if(this.color_equals(t.color))return;let e=new s(this,this.picker.color.clone());this.swatches.push(e),e.select(),this.swatches.length>10-this.fixed_swatches.length&&(this.swatches[0].destroy(),this.swatches.shift()),this.set_swatches()}remove_swatch(t){if(t&&t.preventDefault(),this.active_swatch.fixed)return;this.active_swatch.destroy();let e=this.swatches.indexOf(this.active_swatch);this.swatches.splice(e,1),this.swatches.length?(this.active_swatch=this.swatches[this.swatches.length-1],this.active_swatch.select(),this.picker.color.set(this.active_swatch.color),this.set_swatches()):(this.fixed_swatches.length?(this.active_swatch=this.fixed_swatches[this.fixed_swatches.length-1],this.active_swatch.select(),this.picker.color.set(this.active_swatch.color)):(this.swatches_container.hide(),this.picker.color.reset()),localStorage.removeItem(`color-swatches-${this.index}`))}set_swatches(){let t=[];for(let e of this.swatches)t.push(e.color.hsva);localStorage.setItem(`color-swatches-${this.index}`,JSON.stringify(t))}}return e((function(){void 0!==window.ts?ts.ajax.register(r.initialize,!0):void 0!==window.bdajax?bdajax.register(r.initialize,!0):r.initialize()})),t.ColorWidget=r,Object.defineProperty(t,"__esModule",{value:!0}),window.yafowil=window.yafowil||{},window.yafowil.color=t,t}({},jQuery);
