var yafowil_color=function(t,e){"use strict";class s{constructor(t,e,s=!1){this.widget=t,this.color=e,this.fixed=s,this.elem=$("<div />").addClass("color-swatch").appendTo(this.widget.swatches_container),this.color_layer=$("<div />").addClass("swatch-color-layer").css("background-color",this.color.rgbaString).appendTo(this.elem),this.destroy=this.destroy.bind(this),this.select=this.select.bind(this),this.elem.on("click",this.select)}destroy(){this.elem.off("click",this.select),this.elem.remove()}select(t){$("div.color-swatch").removeClass("selected"),this.elem.addClass("selected"),this.widget.active_swatch=this,this.widget.picker.color.set(this.color)}}class i{constructor(t,e,s,i){this.widget=t,this.elem=e,"hexString"===this.format&&this.elem.attr("maxlength",7),this.format=i,this.color=s,this.update_color(s),this.on_input=this.on_input.bind(this),this.elem.on("input",this.on_input),this.update_color=this.update_color.bind(this)}on_input(t){let e=this.elem.val();if("hsvString"===this.format){let t=this.parse_hsv(e);this.widget.picker.color.set(t)}else if("hsvaString"===this.format){let t=this.parse_hsva(e);this.widget.picker.color.set(t)}"hexString"===this.type&&0===e.length?this.elem.val("#"):this.widget.picker.color.set(e)}hsvString(t){return`hsv(${parseInt(t.hsv.h)}, ${parseInt(t.hsv.s)}%, ${parseInt(t.hsv.v)}%)`}hsvaString(t){return`hsva(${parseInt(t.hsva.h)}, ${parseInt(t.hsva.s)}%, ${parseInt(t.hsva.v)}%, ${parseFloat(t.hsva.a)})`}parse_hsv(t){let e=t.slice(4,-1);e=e.replace(/\%+/g,(function(e,s){return" "===t[s-1]?"0":""})),","===e[0]&&(e="0"+e);let s=JSON.parse(`[${e}]`);return s[0]>360&&(s[0]=360),s[1]>100&&(s[1]=100),s[2]>100&&(s[2]=100),{h:s[0],s:s[1],v:s[2]}}parse_hsva(t){let e=t.slice(5,-1);e=e.replace(/% ?/g,""),e=e.replace(/, ?/g,(function(t,s){return" "!==e[s-1]&&e[s-1]?e[s+2]?t:t+"0":"0"+t})),console.log(e);let s=JSON.parse(`[${e}]`);return s[0]>360&&(s[0]=360),s[1]>100&&(s[1]=100),s[2]>100&&(s[2]=100),s[3]>1&&(s[3]=1),{h:s[0],s:s[1],v:s[2],a:s[3]}}update_color(t){if("hsvString"===this.format){let e=this.hsvString(t);this.elem.val(e)}else if("hsvaString"===this.format){let e=this.hsvaString(t);this.elem.val(e)}else"kelvin"===this.format?this.elem.val(parseInt(t.kelvin)):this.elem.val(t[this.format])}}class o{constructor(t,e){this.widget=t,this.layer=$("<div />").addClass("preview-color-layer"),this.elem=e.addClass("transparent").append(this.layer).insertAfter(this.widget.elem),this.on_click=this.on_click.bind(this),this.elem.on("click",this.on_click)}get color(){return this._color}set color(t){this.layer.css("background-color",t),this._color=t}on_click(){this.widget.open()}}class h{static types={box:"box",r:"red",g:"green",b:"blue",a:"alpha",h:"hue",s:"saturation",v:"value",k:"kelvin"};static component(t,e,s){return{component:iro.ui.Slider,options:{sliderType:t,sliderSize:e,minTemperature:s?s.min:void 0,maxTemperature:s?s.max:void 0}}}constructor(t,e){this.type=e,this.widget=t,this.control_elem=$("<div />").addClass(`control ${e}`).appendTo(t.input_container),this.label_elem=$("<span />").appendTo(this.control_elem),this.input_elem=$("<input />").addClass("control-input").appendTo(this.control_elem)}}let l={h:class extends h{constructor(t,e,s){super(t,s),this.input_elem.attr({type:"numeric",min:0,max:360,maxlength:3}),this.input_elem.val(e.hsva.h),this.label_elem.text("H: "),this.on_input=this.on_input.bind(this),this.input_elem.on("input",this.on_input)}get value(){return parseInt(this.input_elem.val())}set value(t){this.input_elem.val(t)}on_input(){let t=this.widget.picker.color.hsva;t.h=this.value,t.h>=360&&(t.h=360),this.widget.picker.color.set(t)}update(t){this.value=t.hsva.h}},s:class extends h{constructor(t,e,s){super(t,s),this.input_elem.attr({type:"numeric",min:0,max:100,maxlength:3}),this.input_elem.val(e.hsva.s),this.label_elem.text("S: "),this.on_input=this.on_input.bind(this),this.input_elem.on("input",this.on_input)}get value(){return parseInt(this.input_elem.val())}set value(t){this.input_elem.val(t)}on_input(){let t=this.widget.picker.color.hsva;t.h=this.value,t.s>=100&&(t.s=100),this.widget.picker.color.set(t)}update(t){this.value=t.hsva.s}},v:class extends h{constructor(t,e,s){super(t,s),this.input_elem.attr({type:"numeric",min:0,max:100,maxlength:3}),this.input_elem.val(e.hsva.v),this.label_elem.text("V: "),this.on_input=this.on_input.bind(this),this.input_elem.on("input",this.on_input)}get value(){return parseInt(this.input_elem.val())}set value(t){this.input_elem.val(t)}on_input(){let t=this.widget.picker.color.hsva;t.l=this.value,t.l>=100&&(t.l=100),this.widget.picker.color.set(t)}update(t){this.value=t.hsva.v}},a:class extends h{constructor(t,e,s){super(t,s),this.input_elem.attr({type:"number",step:.1,min:0,max:1}),this.input_elem.val(e.rgba.a),this.label_elem.text("A: "),this.on_input=this.on_input.bind(this),this.input_elem.on("input",this.on_input)}get value(){return parseFloat(this.input_elem.val())}set value(t){this.input_elem.val(t)}on_input(){let t=this.widget.picker.color.rgba;this.value>=1&&(this.value=1),t.a=this.value,this.widget.picker.color.set(t)}update(t){this.value=t.rgba.a}},k:class extends h{constructor(t,e,s){super(t,s),this.input_elem.attr({type:"numeric"}),this.input_elem.val(e.kelvin),this.label_elem.text("K: "),this.on_input=this.on_input.bind(this),this.input_elem.on("input",this.on_input)}get value(){return parseInt(this.input_elem.val())}set value(t){this.input_elem.val(t)}on_input(){this.widget.picker.color.set(this.value)}update(t){this.value=parseInt(t.kelvin)}},r:class extends h{constructor(t,e,s){super(t,s),this.input_elem.attr({type:"numeric"}),this.input_elem.val(e.rgba.r),this.label_elem.text("R: "),this.on_input=this.on_input.bind(this),this.input_elem.on("input",this.on_input)}get value(){return this.input_elem.val()}set value(t){this.input_elem.val(t)}on_input(){let t=this.input_elem.val();t>=255?t=255:t<=0&&(t=0),this.input_elem.val(t),this.widget.picker.color.setChannel("rgba","r",t)}update(t){this.value=t.rgba.r}},g:class extends h{constructor(t,e,s){super(t,s),this.input_elem.attr({type:"numeric"}),this.input_elem.val(e.rgba.g),this.label_elem.text("G: "),this.on_input=this.on_input.bind(this),this.input_elem.on("input",this.on_input)}get value(){return this.input_elem.val()}set value(t){this.input_elem.val(t)}on_input(){let t=this.input_elem.val();t>=255?t=255:t<=0&&(t=0),this.input_elem.val(t),this.widget.picker.color.setChannel("rgba","g",t)}update(t){this.value=t.rgba.g}},b:class extends h{constructor(t,e,s){super(t,s),this.input_elem.attr({type:"numeric"}),this.input_elem.val(e.rgba.b),this.label_elem.text("B: "),this.on_input=this.on_input.bind(this),this.input_elem.on("input",this.on_input)}get value(){return this.input_elem.val()}set value(t){this.input_elem.val(t)}on_input(){let t=this.input_elem.val();t>=255?t=255:t<=0&&(t=0),this.input_elem.val(t),this.widget.picker.color.setChannel("rgba","b",t)}update(t){this.value=t.rgba.b}}};class n{static initialize(t){$("input.color-picker",t).each((function(t){let e=$(this),s={format:e.data("format"),preview_elem:e.data("preview_elem"),elements:e.data("elements"),sliders:e.data("sliders"),box_width:e.data("box_width"),box_height:e.data("box_height"),slider_size:e.data("slider_size"),color:e.data("color"),swatches:e.data("swatches"),temp:e.data("temp")};new n(e,s,t)}))}constructor(t,e,s){this.elem=t,this.elem.data("color_widget",this).attr("spellcheck","false"),this.dropdown_elem=$("<div />").addClass("color-picker-wrapper").css("top",this.elem.outerHeight()).insertAfter(this.elem),this.picker_container=$("<div />").addClass("color-picker-container").appendTo(this.dropdown_elem),this.close_btn=$("<button />").addClass("close-button").text("âœ•").appendTo(this.dropdown_elem),this.add_color_btn=$("<button />").addClass("add_color").text("+ Add"),this.remove_color_btn=$("<button />").addClass("remove_color").text("- Remove"),this.buttons=$("<div />").addClass("buttons").append(this.add_color_btn).append(this.remove_color_btn).appendTo(this.dropdown_elem),this.swatches_container=$("<div />").addClass("color-picker-recent").appendTo(this.dropdown_elem),this.input_container=$("<div />").addClass("color-picker-inputs").insertBefore(this.buttons),this.rgb_container=$("<div />").addClass("color-picker-rgb").appendTo(this.input_container),this.hsv_container=$("<div />").addClass("color-picker-hsl").appendTo(this.input_container),this.index=s,this.slider_size=e.slider_size;let h=e.preview_elem?$(e.preview_elem):$("<span />").addClass("color-picker-color");this.preview=new o(this,h);let l=this.init_opts(e);this.picker=new iro.ColorPicker(this.picker_container.get(0),l),this.init_inputs(e),this.swatches=[],this.fixed_swatches=[],this.fix_swatches(e.swatches),this.parse_json(),this.color=this.picker.color.clone(),this.main_input=new i(this,this.elem,this.color,e.format),this.preview&&(this.preview.color=this.color.rgbaString),this.create_swatch=this.create_swatch.bind(this),this.add_color_btn.on("click",this.create_swatch),this.remove_swatch=this.remove_swatch.bind(this),this.remove_color_btn.on("click",this.remove_swatch),this.open=this.open.bind(this),this.elem.on("focus",this.open),this.update_color=this.update_color.bind(this),this.picker.on("color:change",this.update_color),this.close=this.close.bind(this),this.close_btn.on("click",this.close),this.on_keydown=this.on_keydown.bind(this),this.on_click=this.on_click.bind(this)}parse_json(){let t=localStorage.getItem(`color-swatches-${this.index}`);if(t){let e=JSON.parse(t);this.swatches_container.show();for(let t of e)this.swatches.push(new s(this,new iro.Color(t)));this.swatches[this.swatches.length-1].select()}}init_opts(t){let e={color:t.color,width:t.box_width,layout:[]};return t.sliders.forEach((s=>{let i=h.types[s];"box"===i?e.layout.push({component:iro.ui.Box,options:{}}):"kelvin"===i?e.layout.push(h.component(i,t.slider_size,t.temp)):e.layout.push(h.component(i,t.slider_size))})),e}init_inputs(t){this.sliders={};let e=new iro.Color(t.color);t.elements.forEach((t=>{let s=l[t];this.sliders[t]=new s(this,e,t)}))}update_color(){this.color=this.picker.color.clone(),this.preview.color=this.color.rgbaString,this.main_input.update_color(this.color);for(let t in this.sliders)this.sliders[t].update(this.color)}open(t){"none"===this.dropdown_elem.css("display")?(this.dropdown_elem.show(),$(window).on("keydown",this.on_keydown),$(window).on("mousedown",this.on_click)):this.close()}on_keydown(t){"Enter"===t.key||"Escape"===t.key?(t.preventDefault(),this.close()):"Delete"===t.key&&(t.preventDefault(),this.remove_swatch())}on_click(t){let e=this.dropdown_elem;e.is(t.target)||0!==e.has(t.target).length||this.preview.elem.is(t.target)||"block"!==e.css("display")||this.close()}close(t){t&&t.preventDefault(),this.dropdown_elem.hide(),this.elem.blur(),$(window).off("keydown",this.on_keydown),$(window).off("mousedown",this.on_click)}color_equals(t){if(t instanceof iro.Color&&t.hsva.h===this.color.hsva.h&&t.hsva.s===this.color.hsva.s&&t.hsva.v===this.color.hsva.v&&t.hsva.a===this.color.hsva.a)return!0}fix_swatches(t){if(t&&t.length){for(let e of t){let t;e instanceof Array?t={r:e[0],g:e[1],b:e[2],a:e[3]||1}:"string"==typeof e||"object"==typeof e?t=e:console.log(`ERROR: not supported color format at ${e}`),this.fixed_swatches.push(new s(this,new iro.Color(t),!0))}this.swatches_container.show()}}create_swatch(t){t&&(t.preventDefault(),this.swatches_container.show());for(let t of this.fixed_swatches)if(this.color_equals(t.color))return;for(let t of this.swatches)if(this.color_equals(t.color))return;let e=new s(this,this.picker.color.clone());this.swatches.push(e),e.select(),this.swatches.length>10-this.fixed_swatches.length&&(this.swatches[0].destroy(),this.swatches.shift()),this.set_swatches()}remove_swatch(t){if(t&&t.preventDefault(),this.active_swatch.fixed)return;this.active_swatch.destroy();let e=this.swatches.indexOf(this.active_swatch);this.swatches.splice(e,1),this.swatches.length?(this.active_swatch=this.swatches[this.swatches.length-1],this.active_swatch.select(),this.picker.color.set(this.active_swatch.color),this.set_swatches()):(this.fixed_swatches.length?(this.active_swatch=this.fixed_swatches[this.fixed_swatches.length-1],this.active_swatch.select(),this.picker.color.set(this.active_swatch.color)):(this.swatches_container.hide(),this.picker.color.reset()),localStorage.removeItem(`color-swatches-${this.index}`))}set_swatches(){let t=[];for(let e of this.swatches)t.push(e.color.hsva);localStorage.setItem(`color-swatches-${this.index}`,JSON.stringify(t))}}return e((function(){void 0!==window.ts?ts.ajax.register(n.initialize,!0):n.initialize()})),t.ColorWidget=n,Object.defineProperty(t,"__esModule",{value:!0}),void 0===window.yafowil&&(window.yafowil={}),window.yafowil.color=t,t}({},jQuery);
