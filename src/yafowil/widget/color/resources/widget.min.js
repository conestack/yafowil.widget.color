var yafowil_color=function(e,t){"use strict";class s{constructor(e,s,i,o=!1){this.widget=e,this.container=s,this.color=i,this.locked=o,this.selected=!1,this.elem=t("<div />").addClass("color-swatch layer-transparent").appendTo(this.container),this.color_layer=t("<div />").addClass("layer-color").css("background-color",this.color.rgbaString).appendTo(this.elem),o&&this.elem.addClass("locked").append(t('<div class="swatch-mark" />')),this.destroy=this.destroy.bind(this),this.select=this.select.bind(this),this.elem.on("click",this.select)}get selected(){return this._selected}set selected(e){e&&(t("div.color-swatch",this.widget.dropdown_elem).removeClass("selected"),this.elem.addClass("selected"),this.widget.picker.color.set(this.color)),this._selected=e}destroy(){this.locked||(this.elem.off("click",this.select),this.elem.remove())}select(e){this.widget.active_swatch!==this&&(this.widget.active_swatch=this)}}class i{constructor(e,s=[]){this.widget=e,this.elem=t("<div />").addClass("color-picker-recent").appendTo(e.dropdown_elem),this.swatches=[],this.init_swatches(s)}init_swatches(e){if(e&&e.length){for(let t of e){let e;if(t instanceof Array)e={r:t[0],g:t[1],b:t[2],a:t[3]||1};else{if("string"!=typeof t&&"object"!=typeof t)return void console.log(`ERROR: not supported color format at ${t}`);e=t}this.swatches.push(new s(this.widget,this.elem,new iro.Color(e),!0)),this.elem.show()}this.widget.active_swatch=this.swatches[0]}else this.elem.hide()}}class o{constructor(e){this.widget=e,this.elem=t("<div />").addClass("color-picker-recent").appendTo(e.dropdown_elem),this.add_color_btn=t("<button />").addClass("add_color").text("+ Add"),this.remove_color_btn=t("<button />").addClass("remove_color").text("- Remove").hide(),this.buttons=t("<div />").addClass("buttons").append(this.add_color_btn).append(this.remove_color_btn).appendTo(e.dropdown_elem),this.swatches=[],this.init_swatches(),this.create_swatch=this.create_swatch.bind(this),this.add_color_btn.on("click",this.create_swatch),this.remove_swatch=this.remove_swatch.bind(this),this.remove_color_btn.on("click",this.remove_swatch),this.init_swatches=this.init_swatches.bind(this),e.elem.on("yafowil-color-swatches:changed",this.init_swatches)}init_swatches(e){let t=localStorage.getItem("yafowil-color-swatches");for(let e of this.swatches)e.destroy();if(this.swatches=[],t){this.elem.show(),this.remove_color_btn.show();let i=JSON.parse(t);for(let e of i)this.swatches.push(new s(this.widget,this.elem,new iro.Color(e)));if(this.swatches.length>10&&(this.swatches[0].destroy(),this.swatches.shift()),this.swatches.length&&e&&e.origin===this||this.swatches.length&&!e){let e=this.swatches[this.swatches.length-1];this.widget.active_swatch=e}}else this.remove_color_btn.hide()}create_swatch(e){if(e&&"click"===e.type&&e.preventDefault(),this.widget.locked_swatches)for(let e of this.widget.locked_swatches.swatches)if(this.widget.color_equals(e.color))return;for(let e of this.swatches)if(this.widget.color_equals(e.color))return;let t=new s(this.widget,this.elem,this.widget.picker.color.clone());this.swatches.push(t),this.set_swatches()}remove_swatch(e){e&&"click"===e.type&&e.preventDefault(),this.widget.active_swatch||(this.widget.active_swatch=this.swatches[this.swatches.length-1]),this.widget.active_swatch.destroy();let t=this.swatches.indexOf(this.widget.active_swatch);if(this.swatches.splice(t,1),this.swatches.length)this.widget.active_swatch=this.swatches[this.swatches.length-1],this.widget.picker.color.set(this.widget.active_swatch.color);else{if(this.widget.locked_swatches&&this.widget.locked_swatches.swatches.length){let e=this.widget.locked_swatches.swatches;this.widget.active_swatch=e[e.length-1],this.widget.picker.color.set(this.widget.active_swatch.color)}this.elem.hide(),this.remove_color_btn.hide(),this.widget.picker.color.reset()}this.set_swatches()}set_swatches(){let e=[];for(let t of this.swatches)e.push(t.color.hsva);e.length?localStorage.setItem("yafowil-color-swatches",JSON.stringify(e)):localStorage.removeItem("yafowil-color-swatches");let s=new t.Event("yafowil-color-swatches:changed",{origin:this});t("input.color-picker").trigger(s)}}class h{constructor(e,t,s,i,o={min:1e3,max:4e4}){this.widget=e,this.elem=t,this.format=i||"hexString","hexString"===this.format&&this.elem.attr("maxlength",7),this.temperature=o,this.color=s,this.update_color(s),this.on_input=this.on_input.bind(this),this.elem.on("input",this.on_input),this.update_color=this.update_color.bind(this)}on_input(e){let t=this.elem.val();if("kelvin"===this.format){if(t.toString().length<4)return;t<this.temperature.min?t=this.temperature.min:t>this.temperature.max&&(t=this.temperature.max),this.widget.picker.color.kelvin=t}else this.widget.picker.color.set(t);this.elem.val(t)}update_color(e){"kelvin"===this.format?this.elem.val(e.kelvin):this.elem.val(e[this.format])}}class l{constructor(e,s,i){this.widget=e,this.layer=t("<div />").addClass("layer-color"),this.elem=s.addClass("layer-transparent").append(this.layer).insertAfter(this.widget.elem),this.color=i.rgbaString,this.on_click=this.on_click.bind(this),this.elem.on("click",this.on_click)}get color(){return this._color}set color(e){this.layer.css("background-color",e),this._color=e}on_click(){this.widget.open()}}const a={box:"box",wheel:"wheel",r:"red",g:"green",b:"blue",a:"alpha",h:"hue",s:"saturation",v:"value",k:"kelvin"};class c{static initialize(e){t("input.color-picker",e).each((function(){let e=t(this);if(void 0!==window.yafowil_array&&window.yafowil_array.inside_template(e))return;let s={format:e.data("format"),preview_elem:e.data("preview_elem"),sliders:e.data("sliders"),box_width:e.data("box_width"),box_height:e.data("box_height"),slider_size:e.data("slider_size"),color:e.data("color"),locked_swatches:e.data("locked_swatches"),user_swatches:e.data("user_swatches"),temperature:e.data("temperature"),disabled:e.data("disabled"),show_inputs:e.data("show_inputs"),show_labels:e.data("show_labels"),slider_length:e.data("slider_length"),layout_direction:e.data("layout_direction")};new c(e,s)}))}constructor(e,s){e.data("yafowil-color",this),e.addClass("form-control"),this.elem=e,this.elem.attr("spellcheck","false"),this.dropdown_elem=t("<div />").addClass("color-picker-wrapper").css("top",this.elem.outerHeight()).insertAfter(this.elem),this.picker_container=t("<div />").addClass("color-picker-container").appendTo(this.dropdown_elem),this.close_btn=t("<button />").addClass("close-button").text("âœ•").appendTo(this.dropdown_elem),this.slider_size=s.slider_size;let a=this.init_opts(s);this.picker=new iro.ColorPicker(this.picker_container.get(0),a);let c=s.sliders;c&&c.includes("box")&&c.includes("wheel")?(c.indexOf("box")<c.indexOf("wheel")?t("div.IroWheel",this.picker_container).hide():t("div.IroBox",this.picker_container).hide(),this.switch_btn=t("<button />").addClass("iro-switch-toggle").append(t('<i class="glyphicon glyphicon-refresh" />')).appendTo(this.dropdown_elem),this.switch_btn.on("click",(e=>{e.preventDefault(),t("div.IroWheel",this.picker_container).toggle(),t("div.IroBox",this.picker_container).toggle()}))):c||this.picker_container.hide(),s.locked_swatches||s.user_swatches||this.picker_container.css("margin-bottom",0),s.locked_swatches&&(this.locked_swatches=new i(this,s.locked_swatches)),s.user_swatches&&(this.user_swatches=new o(this)),this.color=this.picker.color.clone();let r,n=s.temperature||{min:2e3,max:11e3};this.input_elem=new h(this,this.elem,this.color,s.format,n),r=s.preview_elem?t(s.preview_elem).addClass("yafowil-color-picker-preview"):t("<span />").addClass("yafowil-color-picker-color layer-transparent"),this.preview=new l(this,r,this.color),this.open=this.open.bind(this),this.elem.on("focus",this.open),this.update_color=this.update_color.bind(this),this.picker.on("color:change",this.update_color),this.close=this.close.bind(this),this.close_btn.on("click",this.close),this.on_keydown=this.on_keydown.bind(this),this.on_click=this.on_click.bind(this)}init_opts(e){let t={color:e.color,width:e.box_width,boxHeight:e.box_height||e.box_width,layoutDirection:e.layout_direction||"vertical",layout:[]};return(e.sliders||[]).forEach((s=>{let i=a[s];"box"===i?t.layout.push({component:iro.ui.Box,options:{}}):"wheel"===i?t.layout.push({component:iro.ui.Wheel,options:{}}):t.layout.push({component:iro.ui.Slider,options:{sliderType:i,sliderSize:e.slider_size,sliderLength:e.slider_length,minTemperature:e.temperature.min||void 0,maxTemperature:e.temperature.max||void 0,disabled:e.disabled,showInput:e.show_inputs,showLabel:e.show_labels}})})),t}get active_swatch(){return this._active_swatch}set active_swatch(e){e&&(e.selected=!0),this._active_swatch=e}update_color(){this.color=this.picker.color.clone(),this.preview.color=this.color.rgbaString,this.input_elem.update_color(this.color)}open(e){"none"===this.dropdown_elem.css("display")?(this.dropdown_elem.show(),t(window).on("keydown",this.on_keydown),t(window).on("mousedown",this.on_click)):this.close()}on_keydown(e){if("Enter"===e.key||"Escape"===e.key)e.preventDefault(),this.close();else if("Delete"===e.key)e.preventDefault(),this.user_swatches&&this.user_swatches.remove_swatch();else if("ArrowLeft"===e.key||"ArrowRight"===e.key){if(!this.locked_swatches&&!this.user_swatches)return;let t=this.active_swatch,s=t.locked?this.locked_swatches:this.user_swatches,i=s.swatches.indexOf(t);if(i="ArrowLeft"===e.key?i-1:i+1,i<0){if(!t.locked&&this.locked_swatches){let e=this.locked_swatches.swatches;this.active_swatch=e[e.length-1]}}else if(i>=s.swatches.length){if(t.locked&&this.user_swatches&&this.user_swatches.swatches.length){let e=this.user_swatches.swatches;this.active_swatch=e[0]}}else this.active_swatch=s.swatches[i]}}on_click(e){let t=this.dropdown_elem;t.is(e.target)||0!==t.has(e.target).length||this.preview.elem.is(e.target)||"block"!==t.css("display")||this.close()}close(e){e&&e.preventDefault(),this.dropdown_elem.hide(),this.elem.blur(),t(window).off("keydown",this.on_keydown),t(window).off("mousedown",this.on_click)}color_equals(e){if(e instanceof iro.Color&&e.hsva.h===this.color.hsva.h&&e.hsva.s===this.color.hsva.s&&e.hsva.v===this.color.hsva.v&&e.hsva.a===this.color.hsva.a)return!0}}function r(e,t){c.initialize(t)}function n(){void 0!==window.yafowil_array&&window.yafowil_array.on_array_event("on_add",r)}return t((function(){void 0!==window.ts?ts.ajax.register(c.initialize,!0):void 0!==window.bdajax?bdajax.register(c.initialize,!0):c.initialize(),n()})),e.ColorWidget=c,e.register_array_subscribers=n,Object.defineProperty(e,"__esModule",{value:!0}),window.yafowil=window.yafowil||{},window.yafowil.color=e,e}({},jQuery);
